# --------------------------------------
#  构建运行环境阶段：runner
# --------------------------------------
FROM python:3.11-alpine AS runner

RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
RUN apk add --no-cache \
    aria2 \
    axel \
    ffmpeg \
    && rm -rf /var/cache/apk/* /tmp/* \
    /usr/share/doc /usr/share/man /usr/share/info
# 清理 apk index & dlib cache 的 stub 文件
RUN find /usr -name '*.pyc' -delete && rm -rf /var/cache/apk/*

ENV PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1
# --------------------------------------
#  构建可执行文件阶段：仅生成 wheel
# --------------------------------------
FROM python:3.11-alpine AS builder

# 换国内软件源 & 安装一次性编译工具
RUN sed -i 's|dl-cdn.alpinelinux.org|mirrors.ustc.edu.cn|g' /etc/apk/repositories && \
    apk add --no-cache build-base musl-dev libffi-dev

WORKDIR /src

# 拷贝项目元数据 & 源码
COPY pyproject.toml README.md ./
COPY bili_downloader ./bili_downloader

# 安装 Poetry → 禁用虚拟环境 → 生成 wheel
RUN pip install --no-cache-dir poetry -i https://pypi.tuna.tsinghua.edu.cn/simple && \
    poetry config virtualenvs.create false && \
    poetry build --format=wheel && \
    ls -1 dist/*.whl

# --------------------------------------
#  运行阶段：极致精简
# --------------------------------------
FROM runner

WORKDIR /app

# wheel 安装
COPY --from=builder /src/dist/*.whl ./
RUN ls -la *.whl && pip install --no-cache-dir *.whl && rm -f *.whl

# 创建下载目录并赋权
RUN mkdir -p /app/downloads

# 默认环境变量
ENV DOWNLOAD__DEFAULT_DOWNLOADER=axel \
    DOWNLOAD__DEFAULT_QUALITY=112 \
    DOWNLOAD__DEFAULT_THREADS=16 \
    NETWORK__USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"

VOLUME ["/app/downloads"]

# 检查脚本是否出现
RUN which bili-downloader || (echo "CLI binary not found" && exit 1)

ENTRYPOINT ["bili-downloader"]
CMD ["--help"]